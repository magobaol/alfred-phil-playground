name: Tag and release
permissions:
  contents: write
on:
  pull_request:
    types: [closed, merged]
    branches:
      - main
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.PAT_alfred_phil }}

#      - name: Bump version and push tag
#        id: tag_version
#        uses: anothrNick/github-tag-action@1.61.0 # Don't use @master unless you're happy to test the latest version
#        env:
#          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#          WITH_V: true
        
      - name: Get the new tag without applying it (dry run)
        id: tag_version_dry
        uses: mathieudutour/github-tag-action@v6.1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          custom_release_rules: |
            "fix:patch:Bug Fixes,hotfix:patch:Bug Fixes,feature:minor:Features,change:minor:Changes,breaking:major:Breaking Changes,major:major:Major Changes"          
          dry_run: true
          tag_prefix:

      - name: Install xmlstarlet
        run: sudo apt-get install -y xmlstarlet

      - name: Modify Alfred Workflow version
        run: |
          INFO_PLIST_PATH="./alfred-workflow/info.plist"
          NEW_VERSION="${{ steps.tag_version_dry.outputs.new_tag }}"
          xmlstarlet ed -P --inplace -u "/plist/dict/key[text()='version']/following-sibling::string[1]" -v "${NEW_VERSION}" "${INFO_PLIST_PATH}"

      - name: Commit changes to Alfred workflow version
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "Bump Alfred Workflow version to ${{ steps.tag_version_dry.outputs.new_tag }}"
          branch: main
          push_options: '--force'

      - name: Checkout code again
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.PAT_alfred_phil }}
          fetch-depth: 0

      - name: Bump version and push tag
        id: tag_version
        uses: mathieudutour/github-tag-action@v6.1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          custom_release_rules: |
            "fix:patch:Bug Fixes,hotfix:patch:Bug Fixes,feature:minor:Features,change:minor:Changes,breaking:major:Breaking Changes,major:major:Major Changes"

      - name: Set env
        run: echo "RELEASE_VERSION=${GITHUB_REF#refs/*/}" >> $GITHUB_ENV

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18.x'

      - name: Install dependencies
        run: npm install

      - name: Build the release
        run: npm run release

      - name: GH Release
        uses: softprops/action-gh-release@v0.1.15
        with:
          tag_name: ${{ steps.tag_version.outputs.new_tag }}
          token: ${{ secrets.GITHUB_TOKEN }}
          files: ./dist/alfred-phil.alfredworkflow
